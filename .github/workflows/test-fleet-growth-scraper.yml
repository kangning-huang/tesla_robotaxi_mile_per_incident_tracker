name: Test Fleet Growth Scraper

on:
  workflow_dispatch:  # Manual trigger only for testing
  push:
    branches:
      - 'claude/test-scraper-github-actions-*'
    paths:
      - 'scripts/scrape_fleet_growth.py'
      - '.github/workflows/test-fleet-growth-scraper.yml'

jobs:
  test-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium
          playwright install-deps

      - name: Run fleet growth scraper
        run: python scripts/scrape_fleet_growth.py

      - name: Show output files
        if: always()
        run: |
          echo "=== Output files ==="
          ls -la scripts/fleet_growth_* 2>/dev/null || echo "No output files found"
          echo ""
          for f in scripts/fleet_growth_*.json; do
            if [ -f "$f" ]; then
              echo "=== $f ==="
              python -c "
          import json, sys
          with open('$f') as fh:
              data = json.load(fh)
          print(f\"Scraped at: {data.get('scraped_at', 'N/A')}\")
          print(f\"Data points: {data.get('data_points', 0)}\")
          points = data.get('data', [])
          if points:
              print(f\"Date range: {points[0]['date']} to {points[-1]['date']}\")
              print('First 3:')
              for p in points[:3]:
                  print(f\"  {p}\")
              print('Last 3:')
              for p in points[-3:]:
                  print(f\"  {p}\")
          "
              echo ""
            fi
          done

      - name: Upload scraper output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fleet-growth-data
          path: |
            scripts/fleet_growth_active.json
            scripts/fleet_growth_active.csv
            scripts/fleet_growth_total.json
            scripts/fleet_growth_total.csv
          retention-days: 7
          if-no-files-found: warn
